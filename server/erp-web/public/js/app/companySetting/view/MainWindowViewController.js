/*
 * File: app/view/MyWindowViewController.js
 *
 * This file was generated by Sencha Architect version 3.5.1.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 6.0.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 6.0.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('CompanySetting.view.MainWindowViewController', {
  extend: 'Ext.app.ViewController',
  alias: 'controller.mainwindow',

  init: function () {
    this.getViewModel().set("formData", {
      orderReviewManualOrder: false,
      orderReviewWithBuyerMemo: false,
      orderFinancialReviewManualOrder: false,
      orderErrorIfOversell: false,
      orderErrorIfRequestAftersale: false,
      deliverWeighWarn: false,
      deliverExamineAllowModifyAmount: false,
      stockAreaAllowNegativeQty: false,
      purchaseAllowOverReceipt: false
    });

    var viewCtr = this,
      viewModel = viewCtr.getViewModel();
    Ext.Ajax.request({
      url: '/api/general/company/setting/view',
      success: function (response, opts) {
        var data = JSON.parse(response.responseText).data;
        var formData = viewCtr.getViewModel().get("formData");
        Ext.apply(formData, data);
        viewCtr.getViewModel().notify();
      }
    });

  },

  onCancelButtonClick: function () {
    var viewCtr = this;

    viewCtr.closeView();
  },

  onSaveButtonClick: function () {
    var viewCtr = this,
      view = viewCtr.getView(),
      viewModel = viewCtr.getViewModel(),
      formCmp = view.down("form");
    var formData = viewModel.get("formData");

    if (!formCmp.isValid()) {
      TipsUtil.showTips("提示", '请检查数据填写是否有误', TipsUtil.WARING);
      return;
    }
    if (formData.orderReviewType == null) {
      TipsUtil.showTips("提示", '请选择订单客审类型', TipsUtil.WARING);
      return;
    }
    if (formData.orderReviewType == 'REVIEW_ON_DEMAND' && (formData.orderReviewManualOrder != true && formData.orderReviewManualOrder != 'true')
      && (formData.orderReviewWithBuyerMemo != true && formData.orderReviewWithBuyerMemo != 'true')) {
      TipsUtil.showTips("提示", '按需客审时，请选择至少一种客审要求', TipsUtil.WARING);
      return;
    }
    if (formData.orderFinancialReviewType == null) {
      TipsUtil.showTips("提示", '请选择订单财审类型', TipsUtil.WARING);
      return;
    }
    if (formData.orderFinancialReviewType == 'REVIEW_PER_ORDER_PROFIT' && formData.orderFinancialReviewValue == null) {
      TipsUtil.showTips("提示", '按订单利润财审时, 订单财审系数不能为空', TipsUtil.WARING);
      return;
    }
    if (formData.orderRefundMaxPct == null) {
      TipsUtil.showTips("提示", '请填写退款金额百分比', TipsUtil.WARING);
      return;
    }
    if (formData.deliverType == null) {
      TipsUtil.showTips("提示", '请选择订单发货类型', TipsUtil.WARING);
      return;
    }
    if (formData.deliverExamineOmniBarcode == null) {
      TipsUtil.showTips("提示", '请填写万能条码', TipsUtil.WARING);
      return;
    }
    if (formData.deliverWeighWarn && formData.deliverWeighWarnLimit == null) {
      TipsUtil.showTips("提示", '称重差异提醒时, 称重提醒阀值不能为空', TipsUtil.WARING);
      return;
    }

    //console.log(formData);
    view.el.mask("正在保存，请稍候...");

    formCmp.submit({
      clientValidation: true,
      submitEmptyText: false,
      url: '/api/general/company/setting/save',
      params: {
        data: Ext.encode(formData)
      },
      scope: viewCtr,
      success: '_onSuccessOperate',
      failure: '_onFauilureOperate'
    });
  },

  _onSuccessOperate: function (form, action) {
    var viewCtr = this,
      viewModel = viewCtr.getViewModel(),
      result = Ext.JSON.decode(action.response.responseText);

    viewCtr.getView().el.unmask();
    TipsUtil.showTips("提示", result.data, TipsUtil.WARING);
  },

  _onFauilureOperate: function (form, action) {
    var viewCtr = this,
      result = Ext.JSON.decode(action.response.responseText);

    viewCtr.getView().el.unmask();
    TipsUtil.showTips("提示", result.error.message, TipsUtil.WARING);
  }

});